<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments :: page_head(${pageTitle}, 'none')">
    <!-- These will be replaced by the fragment, but listing for reference -->
 
</head>
<body>

<div class="container-fluid">
    <div th:replace="navigation :: menu"></div>

    <div class="text-center m-3">
        <h2>Manage Glass Protectors | [[${pageTitle}]]</h2>
    </div>

    <form th:action="@{/glass_protectors/save}" method="post" th:object="${protector}"
          style="max-width: 800px; margin: 0 auto;"
          enctype="multipart/form-data" id="glassProtectorForm">

        <input type="hidden" th:field="*{id}"/>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Glass Protector Details</h5>
            </div>
            <div class="card-body">
                <!-- Glass Name -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Glass Name:</label>
                    <div class="col-sm-8">
                        <input th:field="*{name}" type="text" class="form-control"
                              required minlength="2" maxlength="45">
                    </div>
                </div>

                <!-- Price -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Price:</label>
                    <div class="col-sm-8">
                        <input th:field="*{price}" type="number" step="100.00"
                              class="form-control" required>
                    </div>
                </div>

                <!-- Primary Model -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Primary Model:</label>
                    <div class="col-sm-8">
                        <select class="form-control" th:field="*{primaryModel}" required>
                            <option value="" disabled selected>-- Select Primary Model --</option>
                            <option th:each="model : ${listPrimaryModels}" th:value="${model.id}" th:text="${model.name}"></option>
                        </select>
                    </div>
                </div>

                <!-- Brand Selection -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Mobile Brand:</label>
                    <div class="col-sm-8">
                        <select class="form-control select2-single" id="brand" name="brand" required>
                            <option value="" disabled selected>-- Select Brand --</option>
                            <option th:each="brand : ${listBrands}"
                                    th:value="${brand.id}" th:text="${brand.name}"
                                    th:selected="${brand.id == protector.primaryModel?.brand?.id}"></option>
                        </select>
                    </div>
                </div>

                <!-- Compatible Mobiles -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Compatible Mobiles:</label>
                    <div class="col-sm-8">
                        <select class="form-control select2-multi" id="compatibleMobiles" multiple required>
                            <!-- Dynamically loaded -->
                        </select>
                        <small class="form-text text-muted">
                            Search or browse to select multiple compatible models
                        </small>
                    </div>
                </div>

                <!-- Chosen Mobiles Display -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Selected Models:</label>
                    <div class="col-sm-8">
                        <div id="chosenMobiles" class="p-2 border rounded bg-light" style="min-height: 60px;">
                            <!-- Selected models will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Original Compatible Mobiles (for edit mode) -->
                <div id="originalCompatibleMobiles" style="display: none;">
                    <span th:each="mobile : ${protector.compatibleModels}" 
                          th:data-id="${mobile.id}" 
                          th:data-name="${mobile.name}"
                          th:data-brand="${mobile.brand.id}"></span>
                </div>
            </div>
            <div class="card-footer">
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <a th:href="@{/glass_protectors}" class="btn btn-secondary ml-2">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>

    <div th:replace="fragments :: footer"></div>
</div>



<script>
$(document).ready(function () {
    // Store selected mobiles across brand changes
    var selectedMobiles = new Map();
    var mobileBrandMap = new Map(); // Tracks which brand each mobile belongs to
    
    // Initialize Select2
    $(".select2-single").select2({
      
    });
    
    $(".select2-multi").select2({
        theme: "classic",
        width: "100%",
        placeholder: "Select compatible models",
        allowClear: true
    });
    
    // Load stored compatible models (for edit mode)
    $("#originalCompatibleMobiles span").each(function() {
        var id = $(this).data("id");
        var name = $(this).data("name");
        var brandId = $(this).data("brand");
        
        selectedMobiles.set(id.toString(), name);
        mobileBrandMap.set(id.toString(), brandId.toString());
    });
    
    // Handle brand selection change
    $("#brand").change(function() {
        loadMobilesByBrand();
    });
    
    // Handle compatible mobile selection change
    $("#compatibleMobiles").on("change", function() {
        updateSelections();
    });
    
    // Load mobiles for selected brand
    function loadMobilesByBrand() {
        var brandId = $("#brand").val();
        if (!brandId) return;
        
        var url = "[[@{/brands/}]]" + brandId + "/mobiles";
        
        $.get(url, function(responseJSON) {
            var select = $("#compatibleMobiles");
            select.empty();
            
            if (responseJSON.length === 0) {
                select.append($("<option>")
                    .val("")
                    .text("No mobiles available for this brand")
                    .prop("disabled", true));
            } else {
                $.each(responseJSON, function(index, mobile) {
                    var option = $("<option>")
                        .val(mobile.id)
                        .text(mobile.name)
                        .appendTo(select);
                    
                    // Remember this mobile's brand
                    mobileBrandMap.set(mobile.id.toString(), brandId);
                    
                    // Restore selection if this mobile was previously selected
                    if (selectedMobiles.has(mobile.id.toString())) {
                        option.prop("selected", true);
                    }
                });
                
                // Force Select2 to update its display
                select.trigger("change");
            }
        }).fail(function() {
            alert("Error loading mobiles for the selected brand.");
        });
    }
    
    // Update selections based on the select element
    function updateSelections() {
        var brandId = $("#brand").val();
        var select = $("#compatibleMobiles");
        
        // Add newly selected items
        select.find("option:selected").each(function() {
            var id = $(this).val();
            var name = $(this).text();
            
            selectedMobiles.set(id, name);
            mobileBrandMap.set(id, brandId);
        });
        
        // Remove unselected items (only from current brand)
        select.find("option:not(:selected)").each(function() {
            var id = $(this).val();
            
            // Only remove if it belongs to current brand
            if (mobileBrandMap.get(id) === brandId) {
                selectedMobiles.delete(id);
            }
        });
        
        showChosenMobiles();
        createHiddenInputs();
    }
    
    // Display selected mobiles as badges
    function showChosenMobiles() {
        var container = $("#chosenMobiles");
        container.empty();
        
        if (selectedMobiles.size === 0) {
            container.append('<div class="text-muted">No models selected</div>');
            return;
        }
        
        selectedMobiles.forEach(function(name, id) {
            container.append(
                `<span class="badge badge-info m-1 p-2" data-id="${id}">
                    ${name}
                    <i class="fas fa-times-circle ml-1 remove-mobile" data-id="${id}"></i>
                </span>`
            );
        });
        
        // Handle remove clicks
        $(".remove-mobile").click(function() {
            var id = $(this).data("id");
            selectedMobiles.delete(id);
            
            // Deselect in the select element if visible
            var brandId = mobileBrandMap.get(id);
            if (brandId === $("#brand").val()) {
                $("#compatibleMobiles option[value='" + id + "']").prop("selected", false);
                $("#compatibleMobiles").trigger("change.select2");
            }
            
            showChosenMobiles();
            createHiddenInputs();
        });
    }
    
    // Create hidden inputs for form submission
    function createHiddenInputs() {
        // Remove existing hidden inputs
        $("input[name='compatibleMobileIds']").remove();
        
        // Create new hidden inputs
        selectedMobiles.forEach(function(name, id) {
            $("<input>")
                .attr("type", "hidden")
                .attr("name", "compatibleMobileIds")
                .val(id)
                .appendTo("#glassProtectorForm");
        });
    }
    
    // Form submission validation
    $("#glassProtectorForm").submit(function(event) {
        if (selectedMobiles.size === 0) {
            event.preventDefault();
            alert("Please select at least one compatible mobile model.");
            return false;
        }
        
        createHiddenInputs();
        return true;
    });
    
    // Initialize if brand is already selected (edit mode)
    var initialBrand = $("#brand").val();
    if (initialBrand) {
        loadMobilesByBrand();
    }
    
    // Initialize the display of chosen mobiles
    showChosenMobiles();
    createHiddenInputs();
});
</script>


</body>
</html>
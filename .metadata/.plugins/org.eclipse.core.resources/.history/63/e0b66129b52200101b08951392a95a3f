<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments :: page_head(${pageTitle}, 'none')" />


<body>

<div class="container-fluid">
    <div th:replace="navigation :: menu"></div>

    <div class="text-center m-3">
        <h2>Manage Glass Protectors | [[${pageTitle}]]</h2>
    </div>

    <form th:action="@{/glass_protectors/save}" method="post" th:object="${protector}"
          style="max-width: 800px; margin: 0 auto;"
          enctype="multipart/form-data" id="glassProtectorForm">

        <input type="hidden" th:field="*{id}"/>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Glass Protector Details</h5>
            </div>
            <div class="card-body">
                <!-- Glass Name -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Glass Name:</label>
                    <div class="col-sm-8">
                        <input th:field="*{name}" type="text" class="form-control"
                              required minlength="2" maxlength="45">
                    </div>
                </div>

                <!-- Price -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Price:</label>
                    <div class="col-sm-8">
                        <input th:field="*{price}" type="number" step="100.00"
                              class="form-control" required>
                    </div>
                </div>

                <!-- Primary Model -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Primary Model:</label>
                    <div class="col-sm-8">
                        <select class="form-control" th:field="*{primaryModel}" required>
                            <option value="" disabled selected>-- Select Primary Model --</option>
                            <option th:each="model : ${listPrimaryModels}" th:value="${model.id}" th:text="${model.name}"></option>
                        </select>
                    </div>
                </div>

                <!-- Brand Selection -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Mobile Brand:</label>
                    <div class="col-sm-8">
                        <select class="form-control select2-single" id="brand" name="brand" required>
                            <option value="" disabled selected>-- Select Brand --</option>
                            <option th:each="brand : ${listBrands}"
                                    th:value="${brand.id}" th:text="${brand.name}"
                                    th:selected="${brand.id == protector.primaryModel?.brand?.id}"></option>
                        </select>
                    </div>
                </div>

                <!-- Compatible Mobiles -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Compatible Mobiles:</label>
                    <div class="col-sm-8">
                        <select class="form-control select2-multi" id="compatibleMobiles" multiple required>
                            <!-- Dynamically loaded -->
                        </select>
                        <small class="form-text text-muted">
                            Search or browse to select multiple compatible models
                        </small>
                    </div>
                </div>

                <!-- Chosen Mobiles Display -->
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Selected Models:</label>
                    <div class="col-sm-8">
                        <div id="chosenMobiles" class="p-2 border rounded bg-light" style="min-height: 60px;">
                            <!-- Selected models will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Original Compatible Mobiles (for edit mode) -->
                <div id="originalCompatibleMobiles" style="display: none;">
                    <span th:each="mobile : ${protector.compatibleModels}" 
                          th:data-id="${mobile.id}" 
                          th:data-name="${mobile.name}"
                          th:data-brand="${mobile.brand.id}"></span>
                </div>
            </div>
            <div class="card-footer">
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <a th:href="@{/glass_protectors}" class="btn btn-secondary ml-2">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>

    <div th:replace="fragments :: footer"></div>
</div>

<script>
$(document).ready(function () {
	moduleURL = "[[@{/pouches}]]";
	MAX_FILE_SIZE = 2 * 1024 * 1024; // 2 MB

	$(document).ready(function() {
	    var dropBrands = $("#brand");
	    var divCompatibleMobiles = $("#compatibleMobiles");
	    var divChosenMobiles = $("#chosenMobiles");
	    
	    // Store selected mobiles
	    var selectedMobiles = new Map();
	    
	    // Initialize with existing selections
	    divCompatibleMobiles.children("option:selected").each(function() {
	        var mobile = $(this);
	        selectedMobiles.set(mobile.val(), mobile.text());
	    });
	    
	    dropBrands.change(function() {
	        getMobiles();
	    });
	    
	    divCompatibleMobiles.change(function() {
	        // Clear previous selections that are no longer selected
	        var currentSelections = new Set();
	        divCompatibleMobiles.children("option:selected").each(function() {
	            currentSelections.add($(this).val());
	        });
	        
	        // Remove entries that are no longer selected
	        selectedMobiles.forEach(function(value, key) {
	            // Check if this mobile is from the current brand and not selected
	            if (!currentSelections.has(key) && 
	                divCompatibleMobiles.find("option[value='" + key + "']").length > 0) {
	                selectedMobiles.delete(key);
	            }
	        });
	        
	        // Add new selections
	        divCompatibleMobiles.children("option:selected").each(function() {
	            var mobile = $(this);
	            selectedMobiles.set(mobile.val(), mobile.text());
	        });
	        
	        showChosenMobile();
	        updateHiddenInputs();
	    });
	    
	    function showChosenMobile() {
	        divChosenMobiles.empty();
	        
	        // Display all selected mobiles from our map with green badges
	        selectedMobiles.forEach(function(name, id) {
	            var mobName = name.replace(/-/g, '');
	            divChosenMobiles.append(
	                "<span class='badge badge-success m-1' data-id='" + id + "'>" + 
	                mobName + 
	                " <i class='fa fa-times-circle remove-mobile' data-id='" + id + "'></i></span>"
	            );
	        });
	        
	        // Add click handler to remove badges when clicked
	        $(".remove-mobile").click(function() {
	            var mobileId = $(this).data("id");
	            selectedMobiles.delete(mobileId);
	            
	            // Also deselect it in the dropdown if it exists there
	            divCompatibleMobiles.find("option[value='" + mobileId + "']").prop("selected", false);
	            
	            showChosenMobile();
	            updateHiddenInputs();
	        });
	    }
	    
	    function updateHiddenInputs() {
	        // Remove any existing hidden inputs for compatibleMobiles
	        $("input[name='compatibleMobiles']").remove();
	        
	        // Create hidden inputs for all selected mobiles
	        selectedMobiles.forEach(function(name, id) {
	            $("<input>").attr({
	                type: "hidden",
	                name: "compatibleMobiles",
	                value: id
	            }).appendTo("form");
	        });
	    }
	    
	    function getMobiles() {
	        var brandId = dropBrands.val();
	       
	        var url = "[[@{/brands/}]]" + brandId + "/mobiles";
	        
	        $.get(
	            url,
	            function(responseJSON) {
	                // Now empty and repopulate
	                divCompatibleMobiles.empty();
	                
	                if (responseJSON.length === 0) {
	                    $("<option>").val("").text("No mobiles available")
	                        .prop("disabled", true).appendTo(divCompatibleMobiles);
	                } else {
	                    $.each(responseJSON, function(index, mobile) {
	                        var option = $("<option>").val(mobile.id).text(mobile.name)
	                            .appendTo(divCompatibleMobiles);
	                            
	                        // If this mobile was previously selected, select it again
	                        if (selectedMobiles.has(mobile.id.toString())) {
	                            option.prop("selected", true);
	                        }
	                    });
	                }
	                
	                // Update hidden inputs after changing the mobiles list
	                updateHiddenInputs();
	            }
	        ).fail(function() {
	            showErrorDialog("Error fetching mobiles for brand: " + brandId + " " + url);
	        });
	    }
	    
	    // Initialize
	    showChosenMobile();
	    updateHiddenInputs();
	    
	    // Modify the form submit to ensure all selected mobiles are included
	    $("form").submit(function(event) {
	        // Update hidden inputs one last time before submission
	        updateHiddenInputs();
	        
	        // If no mobiles selected, prevent submission
	        if (selectedMobiles.size === 0) {
	            event.preventDefault();
	            showErrorDialog("Please select at least one compatible mobile.");
	            return false;
	        }
	        
	        return true;
	    });
	});
</script>


</body>
</html>